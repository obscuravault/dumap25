<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Obscura Vault - Courses</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="selenix.css">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">

  <style>
    /* ... (keep all your existing CSS unchanged) ... */
  </style>
</head>
<body class="no-js">
  <!-- No JavaScript warning -->
  

  <!-- Header -->
  <header class="header">
    <!-- ... keep existing header code ... -->
  </header>

  <!-- Search overlay -->
  <div class="search-overlay" id="searchOverlay">
    <!-- ... unchanged ... -->
  </div>

  <div class="container player-wrap">
    <!-- ... unchanged player HTML ... -->
  </div>

  <!-- Footer -->
  <footer class="footer">
    <!-- ... unchanged footer HTML ... -->
  </footer>

  <script src="selenix.js"></script>
  <script>
    (function ensureYTAPI(){
      if (window.YT && window.YT.Player) return;
      if (document.getElementById('yt-iframe-api')) return;
      const s = document.createElement('script');
      s.src = "https://www.youtube.com/iframe_api";
      s.id = "yt-iframe-api";
      document.head.appendChild(s);
    })();
  </script>

  <script>
  document.body.classList.remove('no-js');

  // Security measures
  document.addEventListener('contextmenu', e => {e.preventDefault(); return false;});
  document.addEventListener('selectstart', e => {e.preventDefault(); return false;});
  document.addEventListener('dragstart', e => {e.preventDefault(); return false;});
  document.addEventListener('keydown', e => {
    if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['I','J','C'].includes(e.key)) || (e.ctrlKey && e.key.toLowerCase() === 'u') || ((e.ctrlKey||e.metaKey) && ['s','u','p','o'].includes(e.key.toLowerCase()))) {
      e.preventDefault(); return false;
    }
  });
  setInterval(function(){
    const widthThreshold = window.outerWidth - window.innerWidth > 160;
    const heightThreshold = window.outerHeight - window.innerHeight > 160;
    if (!(heightThreshold && widthThreshold) &&
      ((window.Firebug && window.Firebug.chrome && window.Firebug.chrome.isInitialized) || widthThreshold || heightThreshold)) {
      document.body.innerHTML = '<div style="padding:20px;text-align:center;"><h2>Developer Tools Detected</h2><p>Please close developer tools to continue using this site.</p></div>';
      window.stop();
    }
  },1000);

  const state = {items:[],current:null,group:null,subjects:[],colors:{},player:null,apiReady:false,tick:null,seeking:false};
  function getRID(){return new URLSearchParams(location.search).get('rid');}

  function extractYouTubeID(urlOrId){
    if (!urlOrId) return null;
    if (/^[a-zA-Z0-9_-]{11}$/.test(urlOrId)) return urlOrId;
    try {
      const u = new URL(urlOrId);
      if (u.hostname.includes('youtu.be')) return u.pathname.slice(1);
      if (u.searchParams.get('v')) return u.searchParams.get('v');
      const m = u.pathname.match(/\/(embed|shorts|live)\/([a-zA-Z0-9_-]{11})/);
      if (m) return m[2];
    } catch {}
    const m2 = String(urlOrId).match(/([a-zA-Z0-9_-]{11})(?:[^a-zA-Z0-9_-]|$)/);
    return m2?m2[1]:null;
  }

  function fmt(seconds){
    seconds = Math.max(0, Math.floor(seconds||0));
    const h=Math.floor(seconds/3600), m=Math.floor((seconds%3600)/60), s=seconds%60;
    if(h>0) return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }
  const $=sel=>document.querySelector(sel);

  function wireControls(){
    const playBtn=$('#playPause'),playIcon=$('#playIcon'),playLabel=$('#playLabel'),
    seekBar=$('#seekBar'),tL=$('#timeLeft'),tR=$('#timeRight'),speed=$('#speed'),
    pipBtn=$('#pipBtn'),fsBtn=$('#fsBtn'),shell=$('#playerShell'),antiIframe=$('#antiIframe');

    playBtn.addEventListener('click',()=>{
      if(!state.player) return;
      const st=state.player.getPlayerState();
      if(st===YT.PlayerState.PLAYING) state.player.pauseVideo(); else state.player.playVideo();
    });
    antiIframe.addEventListener('click',e=>{
      if(window.innerWidth<=768 && state.player){
        const st=state.player.getPlayerState();
        if(st===YT.PlayerState.PLAYING) state.player.pauseVideo(); else state.player.playVideo();
        e.stopPropagation();
      }
    });
    antiIframe.addEventListener('touchstart',()=>{
      if(window.innerWidth<=768){
        const controls=$('#controls');
        controls.style.opacity='1';controls.style.pointerEvents='all';
        clearTimeout(window.controlsTimeout);
        window.controlsTimeout=setTimeout(()=>{
          controls.style.opacity='0';controls.style.pointerEvents='none';
        },3000);
      }
    });
    seekBar.addEventListener('input',()=>{
      state.seeking=true;
      const dur=state.player?(state.player.getDuration()||0):0;
      const target=(seekBar.value/1000)*dur;
      tL.textContent=fmt(target);
    });
    seekBar.addEventListener('change',()=>{
      const dur=state.player?(state.player.getDuration()||0):0;
      const target=(seekBar.value/1000)*dur;
      if(state.player && Number.isFinite(target)) state.player.seekTo(target,true);
      state.seeking=false;
    });
    speed.addEventListener('change',()=>{if(state.player) state.player.setPlaybackRate(parseFloat(speed.value));});
    pipBtn.addEventListener('click',async()=>{
      try{
        if(document.pictureInPictureElement) await document.exitPictureInPicture();
        else if(document.pictureInPictureEnabled){
          const iframe=$('#ytPlayer');
          if(iframe && iframe.requestPictureInPicture) await iframe.requestPictureInPicture();
        }
      }catch(err){console.error('PiP failed',err);}
    });
    fsBtn.addEventListener('click',()=>{
      const el=shell;
      if(!document.fullscreenElement){
        if(el.requestFullscreen) el.requestFullscreen();
        else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
        else if(el.msRequestFullscreen) el.msRequestFullscreen();
      }else{
        if(document.exitFullscreen) document.exitFullscreen();
        else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
        else if(document.msExitFullscreen) document.msExitFullscreen();
      }
    });

    if(state.tick) clearInterval(state.tick);
    state.tick=setInterval(()=>{
      if(!state.player) return;
      const st=state.player.getPlayerState?.(),cur=state.player.getCurrentTime?.()||0,dur=state.player.getDuration?.()||0;
      if(Number.isFinite(cur)&&Number.isFinite(dur)&&dur>0&&!state.seeking){
        seekBar.value=Math.round((cur/dur)*1000);
        tL.textContent=fmt(cur); tR.textContent=fmt(dur);
      }
      if(st===YT.PlayerState.PLAYING){playIcon.className='bx bx-pause';playLabel.textContent='Pause';}
      else{playIcon.className='bx bx-play';playLabel.textContent='Play';}
    },200);
  }

  function initYT(videoId){
    document.getElementById('ytPlayer').innerHTML='';
    state.player=new YT.Player('ytPlayer',{
      videoId,
      playerVars:{autoplay:1,controls:0,disablekb:1,modestbranding:1,rel:0,fs:0,playsinline:1,iv_load_policy:3,enablejsapi:1},
      events:{onReady:()=>{const rates=state.player.getAvailablePlaybackRates?.()||[0.5,0.75,1,1.25,1.5,1.75,2];
        const speedSel=$('#speed');const currentOptions=Array.from(speedSel.options).map(o=>parseFloat(o.value));
        if(JSON.stringify(currentOptions)!==JSON.stringify(rates)){
          speedSel.innerHTML=rates.map(r=>`<option value="${r}" ${r===1?'selected':''}>${r}×</option>`).join('');
        }
        wireControls();
      }}
    });
  }

  function renderPlayer(){
    const t=document.getElementById('playerTitle');
    if(!state.current){t.textContent='Not found';return;}
    t.textContent=`${state.current.lesson} — ${state.current.partTitle}`;
    document.getElementById('telegramBtn').href=state.current.telegram||'#';
    document.getElementById('resourceBtn').href=state.current.resource||'#';

    const rel=document.getElementById('relatedCards');
    rel.innerHTML='';
    if(state.group){
      state.group.parts.forEach(p=>{
        const card=document.createElement('div');card.className='card';
        const img=document.createElement('img');
        let vidId=extractYouTubeID(p.youtube);
        if(!p.thumb){
          if(vidId) img.src=`https://img.youtube.com/vi/${vidId}/hqdefault.jpg`;
          else img.src=`https://img.youtube.com/vi/9i_UWs0tgJw/hqdefault.jpg`; // default video thumbnail
        } else {
          img.src=p.thumb;
        }
        img.alt=p.partTitle||'thumbnail';
        card.appendChild(img);
        const body=document.createElement('div');body.className='card-body';
        const tag=document.createElement('div');tag.className='tag-row';
        const dot=document.createElement('span');dot.className='dot';dot.style.setProperty('--subject-color',state.colors[state.group.subject]||'#000');
        tag.appendChild(dot);tag.appendChild(document.createTextNode(`${state.group.subject}`));
        const h4=document.createElement('h4');h4.textContent=p.partTitle||'Part';
        const desc=document.createElement('p');desc.textContent=p.description||'';
        const actions=document.createElement('div');actions.className='card-actions';
        const open=document.createElement('button');open.className='btn1';open.textContent=(p.id===state.current.id)?'Now Playing':'Play';
        open.disabled=(p.id===state.current.id);
        open.addEventListener('click',()=>window.location.href=`player.html?rid=${encodeURIComponent(p.id)}`);
        actions.appendChild(open);
        body.appendChild(tag);body.appendChild(h4);body.appendChild(desc);body.appendChild(actions);
        card.appendChild(body);rel.appendChild(card);
      });
    }
  }

  async function boot(){
    selenix.initHeader();
    document.querySelector('[data-back]').addEventListener('click',()=>window.history.back());
    try{
      state.items=await selenix.fetchSheet();
      state.subjects=selenix.uniqueSubjects(state.items);
      state.colors=selenix.subjectColorMap(state.subjects);
      const rid=getRID();
      state.current=state.items.find(x=>x.id===rid);
      if(state.current){
        const groups=selenix.groupByLesson(state.items);
        state.group=groups.find(g=>g.subject===state.current.subject && g.lesson===state.current.lesson);
      }
      renderPlayer();

      function startIfReady(){
        if(window.YT&&window.YT.Player){
          let vid=extractYouTubeID(state.current?.youtube);
          const playerTitle=document.getElementById('playerTitle');
          if(!vid){
            vid='9i_UWs0tgJw';
            playerTitle.textContent='Original video is not uploaded yet. Please wait until the video uploading is Completed.';
          } else {
            playerTitle.textContent=`${state.current.lesson} — ${state.current.partTitle}`;
          }
          initYT(vid);
        } else setTimeout(startIfReady,80);
      }
      startIfReady();
    }catch(e){
      console.error(e);document.getElementById('playerTitle').textContent='Failed to load player.';
    }
  }
  function onYouTubeIframeAPIReady(){}
  boot();

  // Force landscape orientation on fullscreen (mobile)
  document.addEventListener('fullscreenchange', () => {
    if(document.fullscreenElement && screen.orientation && screen.orientation.lock){
      screen.orientation.lock('landscape').catch(err=>console.warn('Could not lock orientation:',err));
    }
  });
  </script>
</body>
</html>

