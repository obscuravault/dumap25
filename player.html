<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Obscura Vault - Courses</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="selenix.css">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <link rel="icon" href="https://yt3.ggpht.com/dvET-k1ACs8PRAd9xldf31l6o93UOpyDH9IVa7DSSOWQxGMX-KaFD0ffB6SCr5Z8rmMrn3O2jA=s800-c-k-c0x00ffffff-no-rj" type="image/svg+xml">

  <!-- Minimal styles for custom controls & overlays -->
  <style>
    /*
     * Custom styles for the video player and its controls.
     * All YouTube branding and native controls are hidden.
     */
    .player-wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 15px;
    }

    .player-shell {
      position: relative;
      width: 100%;
      background: #000;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0,0,0,.35);
      aspect-ratio: 16/9;
      user-select: none;
      -webkit-user-select: none;
      display: none; /* Hidden by default, shown in fullscreen */
    }

    /* Mobile adjustments for player shell */
    @media (max-width: 768px) {
      .player-shell {
        border-radius: 8px;
        aspect-ratio: 16/9;
      }

      /* Hide volume slider on mobile */
      .volume-slider {
        display: none !important;
      }

      /* Show fullscreen button on mobile */
      #fsBtn {
        display: inline-flex !important;
      }

      /* Hide landscape button on mobile */
      #lsBtn {
        display: none !important;
      }
    }

    /* NEW: Status badge container at top-right */
    .status-badge-container {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        gap: 8px;
        z-index: 5;
    }

    /* NEW: Live and Repeat status badges */
    .live-status, .repeat-status {
      display: none; /* Initially hidden */
      color: white;
      font-size: 11px;
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      backdrop-filter: blur(6px);
    }

    .live-status {
        background: rgba(255, 0, 0, 0.7);
    }

    .repeat-status {
        background: rgba(0, 128, 0, 0.7);
        cursor: pointer;
    }

    /*Watermark Image*/
    .ov-watermark1 {
      position: absolute;
      bottom: 10px;  /* distance from bottom */
      right: 10px;   /* distance from right */
      pointer-events: none;
      opacity: 0.18; /* overall transparency */
      mix-blend-mode: difference; /* adapts to light/dark backgrounds */
      width: 100px;  /* set square size */
      height: 100px; /* same as width */
      overflow: hidden; /* ensures image stays within the square */
      z-index: 3;
    }

    .ov-watermark1 img {
      width: 100%;
      height: 100%;
      object-fit: cover; /* crops image to fill square */
      filter: invert(1); /* inverts colors: white → black */
      opacity: 0.6;      /* fine-tune visibility */
    }

    /* Watermark */
    .ov-watermark {
      position: absolute;
      inset: 0;
      pointer-events: none;
      display: grid;
      place-items: center;
      opacity: .18;
      mix-blend-mode: darken;
      font-weight: 700;
      color: #00f;
      text-transform: uppercase;
      letter-spacing: 4px;
      font-size: clamp(16px, 5vw, 42px);
      background-image:
        repeating-linear-gradient(
          -30deg,
          rgba(0,0,255,.12) 0 40px,
          rgba(0,0,255,.15) 40px 80px
        );
      z-index: 3;
    }

    .ov-watermark span {
      text-shadow: 0 1px 0 rgba(0,0,0,.8);
    }

    /* Video cropping and aspect ratio adjustments - UPDATED FOR ALL DEVICES */
    .youtube-video-host-container {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      overflow: hidden;
    }

    /* Apply 50px crop to ALL devices */
    .yt-host {
      position: absolute;
      width: 100%;
      height: 110.2%; /* Scale for 1080p to 980p crop (50px top + 50px bottom = 100px total) */
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .yt-iframe {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      /* Crop 50px from top and bottom (4.63% of 1080px) for ALL devices */
      clip-path: inset(4.63% 0 4.63% 0);
      -webkit-clip-path: inset(4.63% 0 4.63% 0);
      border: 0;
    }

    /* Black overlay bars for cropped areas - UPDATED FOR ALL DEVICES */
    .crop-overlay {
      position: absolute;
      left: 0;
      right: 0;
      height: 4.63%; /* Reduced from 8.33% to 4.63% for ALL devices */
      background: #000;
      z-index: 2;
      pointer-events: none;
    }

    .crop-overlay.top {
      top: 0;
    }

    .crop-overlay.bottom {
      bottom: 0;
    }

    /* Fullscreen support - UPDATED FOR ALL DEVICES */
    .player-shell:fullscreen .yt-host,
    .player-shell:-webkit-full-screen .yt-host,
    .player-shell:-moz-full-screen .yt-host,
    .player-shell:-ms-fullscreen .yt-host {
      height: 110.2%; /* Updated for 50px crop */
    }

    .player-shell:fullscreen .yt-iframe,
    .player-shell:-webkit-full-screen .yt-iframe,
    .player-shell:-moz-full-screen .yt-iframe,
    .player-shell:-ms-fullscreen .yt-iframe {
      clip-path: inset(4.63% 0 4.63% 0);
      -webkit-clip-path: inset(4.63% 0 4.63% 0);
    }

    /* REMOVED: Mobile no-crop overrides - now all devices use the same crop */

    /* Transparent layer that blocks direct interaction with iframe */
    .anti-iframe {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 4;
      background: transparent;
    }

    /* Double tap skip overlay */
    .skip-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      z-index: 10;
      pointer-events: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
    }

    .skip-overlay.show {
      display: flex;
      opacity: 1;
    }

    .skip-overlay .skip-icon {
      font-size: 4rem;
      color: white;
      text-shadow: 0 0 10px rgba(0,0,0,0.5);
    }

    /* NEW: Mobile tap zones */
    .tap-zone {
        position: absolute;
        top: 0;
        height: 100%;
        width: 33.333%; /* Divide screen into three equal zones */
        z-index: 5;
    }
    .tap-zone.left {
        left: 0;
    }
    .tap-zone.center {
        left: 33.333%;
    }
    .tap-zone.right {
        right: 0;
    }

    /* NEW: Info message overlay */
    .info-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 1rem 2rem;
      border-radius: 1rem;
      font-size: 1.25rem;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
      pointer-events: none;
      z-index: 10;
    }
    .info-message.active {
      opacity: 1;
    }

    /* Controls bar */
    .controls {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 5;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 10px 12px;
      background: linear-gradient(to top, rgba(0,0,0,.75), rgba(0,0,0,.0));
      transition: opacity 0.3s ease;
    }

    /* Hide controls when not interacting on mobile */
    @media (max-width: 768px) {
      .player-shell:not(:hover) .controls {
        opacity: 0;
        pointer-events: none;
      }

      .player-shell:hover .controls {
        opacity: 1;
      }

      /* Hide volume controls in normal mobile view */
      .volume-control {
        display: none;
      }

      /* Mobile layout for controls */
      .controls {
        flex-direction: column;
        gap: 0;
      }

      .row {
        flex-wrap: wrap;
      }
    }

    .row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn1, .icon {
      appearance: none;
      border: 0;
      outline: 0;
      background: rgba(0,0,0,1);
      color: #fff;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(6px);
    }

    .btn1:hover, .icon:hover {
      background: rgba(255,255,255,.18);
      color: #000;
      padding: 8px 12px;
      border-radius: 12px;
    }

    .btn1:active, .icon:active {
      transform: translateY(1px);
    }

    .btn, .icon {
      appearance: none;
      border: 0;
      outline: 0;
      background: rgba(255,255,255,.12);
      color: #fff;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(6px);
    }

    .btn:hover, .icon:hover {
      background: rgba(255,255,255,.18);
    }

    .btn:active, .icon:active {
      transform: translateY(1px);
    }

    /* Time + seek */
    .time {
      color: #fff;
      font-variant-numeric: tabular-nums;
      font-size: 13px;
      opacity: .9;
      min-width: 110px;
      text-align: center;
    }

    @media (max-width: 768px) {
        #timeRight {
            display: inline-block; /* Ensure it's displayed on mobile */
        }
    }

    .seek-time {
      color: #fff;
      font-variant-numeric: tabular-nums;
      font-size: 13px;
      opacity: .9;
      text-align: center;
      width: 100%;
    }

    .seek {
      flex: 1 1 auto;
      display: flex;
      align-items: center;
      min-width: 120px;
      gap: 10px;
    }

    /* UPDATED: Progress Bar Styles with gradient colors */
    .seek input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(to right, #6a11cb 0%, #2575fc 100%);
      background-size: 0% 100%;
      background-repeat: no-repeat;
      outline: none;
      cursor: pointer;
      transition: background 0.1s ease;
    }

    /* Webkit (Chrome, Safari) */
    .seek input[type="range"]::-webkit-slider-runnable-track {
      -webkit-appearance: none;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,.3);
    }

    .seek input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #fff;
      cursor: pointer;
      box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.5);
      border: 2px solid #fff;
      transition: all 0.2s ease;
      margin-top: -4px;
    }

    .seek input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 0 4px rgba(106, 17, 203, 0.7);
    }

    /* Firefox */
    .seek input[type="range"]::-moz-range-track {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,.3);
      border: none;
    }

    .seek input[type="range"]::-moz-range-progress {
      background: linear-gradient(to right, #6a11cb, #2575fc);
      height: 6px;
      border-radius: 999px;
    }

    .seek input[type="range"]::-moz-range-thumb {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #fff;
      cursor: pointer;
      box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.5);
      border: 2px solid #fff;
      transition: all 0.2s ease;
    }

    .seek input[type="range"]::-moz-range-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 0 4px rgba(106, 17, 203, 0.7);
    }

    /* Volume control */
    .volume-control {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* UPDATED: Volume slider with matching gradient */
    .volume-slider {
      -webkit-appearance: none;
      appearance: none;
      width: 80px;
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(to right, #6a11cb 0%, #2575fc 100%);
      background-size: 100% 100%;
      background-repeat: no-repeat;
      outline: none;
      cursor: pointer;
    }

    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #fff;
      cursor: pointer;
      box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.5);
      border: 2px solid #fff;
      transition: all 0.2s ease;
    }

    .volume-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 0 4px rgba(106, 17, 203, 0.7);
    }

    .volume-slider::-moz-range-thumb {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #fff;
      cursor: pointer;
      box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.5);
      border: 2px solid #fff;
      transition: all 0.2s ease;
    }

    .volume-slider::-moz-range-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 0 4px rgba(106, 17, 203, 0.7);
    }

    .volume-slider::-moz-range-progress {
      background: linear-gradient(to right, #6a11cb, #2575fc);
      height: 6px;
      border-radius: 999px;
    }

    /* Mobile adjustments for controls */
    @media (max-width: 768px) {
      .controls {
        padding: 8px 10px;
      }

      .btn, .btn1, .icon {
        min-height: 36px;
        min-width: 36px;
        justify-content: center;
      }

      .time {
        font-size: 11px;
        min-width: 40px;
        text-align: center;
      }

      .seek input[type="range"] {
        height: 5px;
      }

      .seek input[type="range"]::-webkit-slider-thumb {
        width: 12px;
        height: 12px;
      }

      .seek input[type="range"]::-moz-range-thumb {
        width: 12px;
        height: 12px;
      }

      .volume-slider {
        width: 60px;
        height: 5px;
      }

      .volume-slider::-webkit-slider-thumb {
        width: 12px;
        height: 12px;
      }

      .volume-slider::-moz-range-thumb {
        width: 12px;
        height: 12px;
      }

      /* Hide text labels on mobile to save space */
      .icon span {
        display: none;
      }

      .right {
        gap: 6px;
      }

      /* The seek bar container to be shown/hidden */
      #seekBarContainer {
          order: -1; /* This moves the progress bar to the top */
          padding-bottom: 8px;
          display: flex; /* Ensure it's a flex container for the range input */
          align-items: center;
          width: 100%;
          min-width: 100%;
      }

      /* Hide time elements from the main seek bar on mobile */
      #seekBarContainer .time {
          display: none;
      }
    }

    /* Right-side controls */
    .right {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
      position: relative; /* For settings menu positioning */
    }

    /* Settings menu */
    .settings-menu {
      position: absolute;
      bottom: 100%;
      right: 0;
      min-width: 150px;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 12px;
      display: none; /* Initially hidden */
      flex-direction: column;
      gap: 12px;
      transform: translateY(-8px);
      transition: all 0.2s ease-in-out;
      overflow-y: auto; /* Enable scrolling if content exceeds max height */
    }

    .settings-menu.active {
      display: flex;
    }

    .settings-menu .menu-section {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .settings-menu .menu-title {
      color: #aaa;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    /* Back button style */
    .settings-menu .back-button {
        background: transparent;
        border: none;
        color: #fff;
        padding: 8px 12px;
        border-radius: 8px;
        text-align: left;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .settings-menu .back-button:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .settings-menu .menu-item {
      background: transparent;
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s ease;
      white-space: nowrap;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .settings-menu .menu-item.active,
    .settings-menu .menu-item:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Changes to match the image style */
    .settings-menu .menu-item {
        justify-content: flex-start; /* Align text to the left */
        gap: 10px; /* Add space between dot and text */
        padding: 6px 12px; /* Adjust padding for a tighter list */
    }

    .settings-menu .menu-item.active::before {
        content: '\2022'; /* Unicode for a bullet point */
        color: #fff;
        font-size: 1.2em;
        line-height: 1;
    }

    .settings-menu .menu-item .checkmark {
      display: none;
    }

    /* Mobile tap area improvements */
    @media (max-width: 768px) {
      .icon, .btn, .btn1 {
        min-height: 36px;
        min-width: 36px;
        justify-content: center;
      }
    }

    /* Fullscreen styles */
    .player-shell:fullscreen {
      width: 100%;
      height: 100%;
      border-radius: 0;
      max-width: none;
    }

    .player-shell:-webkit-full-screen {
      width: 100%;
      height: 100%;
      border-radius: 0;
      max-width: none;
    }

    .player-shell:-moz-full-screen {
      width: 100%;
      height: 100%;
      border-radius: 0;
      max-width: none;
    }

    .player-shell:-ms-fullscreen {
      width: 100%;
      height: 100%;
      border-radius: 0;
      max-width: none;
    }

    /* Prevent image/element dragging */
    img, .player-shell, .anti-iframe {
      -webkit-user-drag: none;
    }

    /* Back button row */
    .back-row {
      margin-bottom: 15px;
    }

    .back-row button {
      background: rgba(255,255,255,.1);
      border: none;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    /* Player CTA buttons */
    .player-cta {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    @media (max-width: 768px) {
      .player-cta {
        flex-direction: column;
      }

      .player-cta .btn1 {
        width: 100%;
        text-align: center;
        justify-content: center;
      }
    }

    /* Related cards */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    @media (max-width: 768px) {
      .cards {
        grid-template-columns: 1fr;
        gap: 15px;
      }
    }

    /* NEW: Card styles with play icon overlay */
    .card {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }

    .card img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      display: block;
    }

    .card-body {
      padding: 16px;
    }

    .tag-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--subject-color, #000);
    }

    .card h4 {
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 600;
      color: #333;
      line-height: 1.3;
    }

    .card p {
      margin: 0;
      font-size: 14px;
      color: #666;
      line-height: 1.4;
    }

    /* Play icon overlay */
    .play-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .card:hover .play-overlay {
      opacity: 1;
    }

    .play-icon {
      font-size: 48px;
      color: white;
      background: rgba(106, 17, 203, 0.8);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s ease;
    }

    .card:hover .play-icon {
      transform: scale(1.1);
    }

    /* No JavaScript warning */
    .no-js-message {
      display: none;
      text-align: center;
      padding: 2rem;
      background: #f8d7da;
      color: #721c24;
      border-radius: 8px;
      margin: 2rem 0;
    }

    .no-js .no-js-message {
      display: block;
    }

    .no-js .player-shell,
    .no-js .player-cta,
    .no-js .cards {
      display: none;
    }

    /* Styles for the time row */
    .time-row {
      display: flex;
      justify-content: space-between;
      width: 100%;
      margin-top: 4px; /* Space between progress bar and time */
    }

    /* Style for the seek time span */
    .seek-time {
      font-variant-numeric: tabular-nums;
      font-size: 13px;
      opacity: .9;
      color: #fff;
    }

    /* NEW: Loading text styles */
    .loading-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      font-size: 1.25rem;
      font-weight: bold;
      z-index: 10;
      display: none; /* Initially hidden */
    }

    /* NEW: Loading overlay styles */
    .loading-overlay {
      position: absolute;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 6; /* Above video, below loading text */
      display: none; /* Initially hidden */
    }

    /* NEW: Attend Now Button Styles */
    .attend-now-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      text-align: center;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 14px;
      margin: 2rem 0;
    }

    .attend-now-btn {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      border: none;
      padding: 16px 32px;
      font-size: 1.2rem;
      font-weight: bold;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(106, 17, 203, 0.4);
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      margin: 1rem 0;
    }

    .attend-now-btn:disabled {
      background: linear-gradient(135deg, #cccccc 0%, #999999 100%);
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .attend-now-btn:disabled:hover {
      transform: none;
      box-shadow: none;
    }

    .attend-now-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(106, 17, 203, 0.6);
    }

    .attend-now-btn:active:not(:disabled) {
      transform: translateY(0);
    }

    .attend-now-btn i {
      font-size: 1.4rem;
    }

    /* Loading spinner for button */
    .btn-loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Browser Warning Styles */
    .browser-warning {
      display: none;
      background: #f8d7da;
      color: #721c24;
      padding: 1.5rem;
      border-radius: 8px;
      margin: 2rem 0;
      text-align: center;
      border-left: 4px solid #f5c6cb;
    }

    .browser-warning.active {
      display: block;
    }

    .browser-warning h3 {
      margin-top: 0;
      color: #721c24;
    }

    .browser-icons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 1rem 0;
    }

    .browser-icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .browser-icon i {
      font-size: 2rem;
      color: #2575fc;
    }

    .browser-icon span {
      font-size: 0.9rem;
      color: #495057;
    }

    /* Lesson Info Styles */
    .lesson-info {
      background: rgba(106, 17, 203, 0.1);
      padding: 1.5rem;
      border-radius: 12px;
      margin: 1rem 0;
      border-left: 4px solid #6a11cb;
    }

    .lesson-info h3 {
      margin-top: 0;
      color: #6a11cb;
    }

    .lesson-meta {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.9rem;
      color: #495057;
    }

    .meta-item i {
      color: #6a11cb;
    }
  </style>
</head>
<body class="no-js">
  <!-- No JavaScript warning -->
  <div class="no-js-message">
    <h2>JavaScript Required</h2>
    <p>This page requires JavaScript to function properly. Please enable JavaScript in your browser settings.</p>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="container nav">
      <a class="brand" href="index.html">
        <img alt="selenix logo">
        <div class="logo-text">Obscura Vault</div>
      </a>
      <nav class="nav-links">
        <a href="index.html">Home</a>
        <a href="index.html#about">About</a>
        <a href="lessons.html">Lessons</a>
        <a href="index.html#contact">Contact</a>
        <button class="icon-btn" data-open-search aria-label="Search">
          <img class="search-icon" src="https://cdn-icons-png.flaticon.com/128/3686/3686896.png" alt="Search" loading="lazy" decoding="async">
        </button>
      </nav>
      <button class="icon-btn hamburger" aria-label="Menu"><span></span><span></span><span></span></button>
    </div>
    <div class="mobile-drawer">
      <a href="index.html">Home</a>
      <a href="index.html#about">About</a>
      <a href="lessons.html">Lessons</a>
      <a href="index.html#contact">Contact</a>
      <a href="#" data-open-search>Search</a>
    </div>
    <div class="mobile-searchbar">
      <form id="mobileSearchForm">
        <input id="mobileSearch" placeholder="Search lessons...">
        <button type="submit">Search</button>
      </form>
    </div>
  </div>

  <!-- Search overlay -->
  <div class="search-overlay" id="searchOverlay">
    <div class="search-card">
      <h3>Search lessons</h3>
      <div class="search-row">
        <input id="globalSearchInput" placeholder="Type keyword...">
        <button id="globalSearchGo">Search</button>
      </div>
    </div>
  </div>

  <div class="container player-wrap">
    <div class="back-row">
      <button data-back>← Back</button>
    </div>

    <h2 id="playerTitle">Loading...</h2>

    <!-- Browser Warning -->
    <div id="browserWarning" class="browser-warning">
      <h3>Unsupported Browser</h3>
      <p>Please use one of the following browsers to access this content:</p>
      <div class="browser-icons">
        <div class="browser-icon">
          <i class='bx bxl-chrome'></i>
          <span>Chrome</span>
        </div>
        <div class="browser-icon">
          <i class='bx bxl-edge'></i>
          <span>Edge</span>
        </div>
        <div class="browser-icon">
          <i class='bx bxl-firefox'></i>
          <span>Firefox</span>
        </div>
        <div class="browser-icon">
          <i class='bx bxl-safari'></i>
          <span>Safari</span>
        </div>
      </div>
    </div>

    <!-- Lesson Info -->
    <div id="lessonInfo" class="lesson-info">
      <h3>Course Information</h3>
      <p id="lessonDescription">Loading course information...</p>
      <div class="lesson-meta">
        <div class="meta-item">
          <i class='bx bx-time'></i>
          <span id="lessonDuration">Duration: Loading...</span>
        </div>
        <div class="meta-item">
          <i class='bx bx-video'></i>
          <span id="lessonQuality">Quality: 1080p</span>
        </div>
        <div class="meta-item">
          <i class='bx bx-user'></i>
          <span id="lessonInstructor">Instructor: Loading...</span>
        </div>
      </div>
    </div>

    <!-- Attend Now Container -->
    <div class="attend-now-container" id="attendNowContainer">
      <h3>Ready to Start Learning?</h3>
      <p id="attendNowMessage">Preparing video content...</p>
      <button class="attend-now-btn" id="attendNowBtn" disabled>
        <span class="btn-loading"></span>
        Loading Video...
      </button>
      <p><small>Note: The lesson will open in fullscreen mode for the best learning experience</small></p>
    </div>

    <!-- Custom Player (Hidden by default) -->
    <div class="player-shell" id="playerShell" aria-label="video player">
      <!-- NEW: Loading overlay to hide video content -->
      <div id="loadingOverlay" class="loading-overlay"></div>

      <!-- Crop overlay bars - UPDATED: Reduced height for ALL devices -->
      <div class="crop-overlay top"></div>
      <div class="crop-overlay bottom"></div>

      <!-- Host for YouTube iframe -->
      <div class="youtube-video-host-container" id="obscuraVideoHost">
        <div class="yt-host">
          <div id="ytPlayer" class="yt-iframe" title="YouTube player"></div>
        </div>
      </div>

      <!-- NEW: Tap Zones for Mobile Shortcuts -->
      <div class="tap-zone left" id="rewindZone"></div>
      <div class="tap-zone center" id="centerZone"></div>
      <div class="tap-zone right" id="forwardZone"></div>

      <!-- Transparent blocker over the iframe (prevents context menu & direct clicks) -->
      <div class="anti-iframe" id="antiIframe" oncontextmenu="return false;"></div>

      <!-- NEW: Info message overlay -->
      <div id="infoMessage" class="info-message"></div>

      <!-- NEW: Status badges container -->
      <div class="status-badge-container">
          <span id="repeatStatus" class="repeat-status">REPEAT</span>
          <span id="liveStatus" class="live-status">LIVE</span>
      </div>

      <!-- NEW: Custom loading text -->
      <div id="loadingText" class="loading-text">Loading...</div>

      <!-- Watermark -->
      <div class="ov-watermark" aria-hidden="true"><span>Obscura Vault</span></div>
      <div class="ov-watermark1">
        <img src="http://lumosbio.infy.uk/wp-content/uploads/2025/08/Imaf.png" alt="Watermark">
      </div>

      <!-- Custom Controls -->
      <div class="controls" id="controls">
        <!-- The seek bar container -->
        <div class="seek" id="seekBarContainer">
          <input type="range" id="seekBar" min="0" max="1000" step="1" value="0" aria-label="Seek">
        </div>

        <div class="row">
          <button class="icon" id="playPause" aria-label="Play/Pause">
            <i class='bx bx-play' id="playIcon"></i>
            <span id="playLabel">Play</span>
          </button>

          <div class="volume-control">
            <button class="icon" id="muteBtn" aria-label="Mute/Unmute">
              <i class='bx bx-volume-full' id="volumeIcon"></i>
            </button>
            <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="100" aria-label="Volume">
          </div>

          <div class="right">
            <!-- Time display -->
            <span class="seek-time" id="timeDisplay">
              <span id="currentTime">00:00</span> / <span id="totalTime">00:00</span>
            </span>

            <!-- Skip buttons -->
            <button class="icon" id="rewindBtn" aria-label="Rewind 5 seconds">
              <i class='bx bx-skip-previous'></i>
            </button>
            <button class="icon" id="forwardBtn" aria-label="Forward 5 seconds">
              <i class='bx bx-skip-next'></i>
            </button>

            <!-- Settings button and menu -->
            <button class="icon" id="settingsBtn" aria-label="Settings">
              <i class='bx bx-cog'></i>
              <span>Speed</span>
            </button>
            <div class="settings-menu" id="settingsMenu">
              <!-- Playback speed options will be populated here -->
            </div>

            <button class="icon" id="lsBtn" aria-label="Landscape Fullscreen" style="display: none;">
              <i class='bx bx-expand-horizontal'></i>
              <span>Landscape</span>
            </button>

            <button class="icon" id="fsBtn" aria-label="Fullscreen">
              <i class='bx bx-fullscreen'></i>
              <span>Full</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="player-cta" style="margin-top:10px">
      <a class="btn1" id="telegramBtn" target="_blank">View in Youtube</a>
      <a class="btn1 secondary" id="resourceBtn" target="_blank">Download PDF</a>
    </div>

    <div class="bar" id="relatedBar" style="margin:20px 0 16px"></div>
    <h3 id="relatedTitle">Other parts in this lesson</h3>
    <div class="cards" id="relatedCards"></div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-top-art"></div>
    <div class="container">
      <div class="footer-inner" style="grid-column:1/-1;display:flex;flex-direction:column;align-items:center;text-align:center;gap:18px;padding-top:10px;padding-bottom:50px">
        <div class="footer-social" style="display:flex;gap:18px">
          <a href="https://t.me/ObscuraVaulfOfficial" target="_blank" aria-label="Telegram" title="Telegram"
             style="width:44px;height:44px;border-radius:50%;background:#fff;color:#111;display:inline-flex;align-items:center;justify-content:center;font-size:26px;text-decoration:none">
            <i class='bx bxl-telegram'></i>
          </a>
          <a href="https://www.youtube.com/@ObscuraVault-Official" target="_blank" aria-label="YouTube" title="YouTube"
             style="width:44px;height:44px;border-radius:50%;background:#fff;color:#111;display:inline-flex;align-items:center;justify-content:center;font-size:26px;text-decoration:none">
            <i class='bx bxl-youtube'></i>
          </a>
        </div>
        <nav class="footer-menu" style="display:flex;gap:26px;flex-wrap:wrap;justify-content:center">
          <a href="index.html" style="color:#eaeaea;text-decoration:none">Home</a>
          <a href="index.html#about" style="color:#eaeaea;text-decoration:none">About</a>
          <a href="lessons.html" style="color:#eaeaea;text-decoration:none">Lessons</a>
          <a href="index.html#contact" style="color:#eaeaea;text-decoration:none">Contact</a>
        </nav>
        <div class="footer-copy" style="font-size:13px;color:#bdbdbd">© 2025 Obscura Vault. All Rights Reserved</div>
      </div>
    </div>
  </footer>

  <!-- Shared helpers -->
  <script src="selenix.js"></script>

  <!-- YouTube IFrame API (do not async-defer when you need onYouTubeIframeAPIReady) -->
  <script>
    // Load the YouTube API once (idempotent)
    (function ensureYTAPI(){
      if (window.YT && window.YT.Player) return;
      if (document.getElementById('yt-iframe-api')) return;
      const s = document.createElement('script');
      s.src = "https://www.youtube.com/iframe_api";
      s.id = "yt-iframe-api";
      document.head.appendChild(s);
    })();
  </script>

  <!-- Page script -->
  <script>
  // Remove no-js class if JavaScript is enabled
  document.body.classList.remove('no-js');

  // ---- Browser Detection ----
  function isSupportedBrowser() {
    const userAgent = navigator.userAgent.toLowerCase();
    
    // Check for Chrome, Edge, Firefox, or Safari
    const isChrome = /chrome/.test(userAgent) && !/edg/.test(userAgent);
    const isEdge = /edg/.test(userAgent);
    const isFirefox = /firefox/.test(userAgent);
    const isSafari = /safari/.test(userAgent) && !/chrome/.test(userAgent);
    
    return isChrome || isEdge || isFirefox || isSafari;
  }

  // Check browser on page load
  if (!isSupportedBrowser()) {
    document.getElementById('browserWarning').classList.add('active');
    document.getElementById('attendNowContainer').style.display = 'none';
    document.getElementById('lessonInfo').style.display = 'none';
  }

  // ---- Security Measures ----
  // Disable right-click context menu
  document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    return false;
  });

  // Disable text selection
  document.addEventListener('selectstart', function(e) {
    e.preventDefault();
    return false;
  });

  // Disable drag and drop
  document.addEventListener('dragstart', function(e) {
    e.preventDefault();
    return false;
  });

  // Disable developer tools (F12, Ctrl+Shift+I, etc.)
  document.addEventListener('keydown', function(e) {
    // Disable F12
    if (e.key === 'F12') {
      e.preventDefault();
      return false;
    }

    // Disable Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+Shift+C, Ctrl+U
    if (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key)) {
      e.preventDefault();
      return false;
    }

    // Disable Ctrl+U (view source)
    if (e.ctrlKey && e.key === 'u') {
      e.preventDefault();
      return false;
    }

    // Block common "save/open" combos
    if ((e.ctrlKey || e.metaKey) && ['s','u','p','o'].includes(e.key.toLowerCase())) {
      e.preventDefault();
      return false;
    }
  });

  // Detect if dev tools are open (basic detection)
  setInterval(function() {
    const widthThreshold = window.outerWidth - window.innerWidth > 160;
    const heightThreshold = window.outerHeight - window.innerHeight > 160;
    const orientation = widthThreshold ? 'vertical' : 'horizontal';

    if (!(heightThreshold && widthThreshold) &&
        ((window.Firebug && window.Firebug.chrome && window.Firebug.chrome.isInitialized) ||
         widthThreshold || heightThreshold)) {
      // Dev tools detected - redirect or show warning
      document.body.innerHTML = '<div style="padding: 20px; text-align: center;"><h2>Developer Tools Detected</h2><p>Please close developer tools to continue using this site.</p></div>';
      window.stop();
    }
  }, 1000);

  // ---- State ----
  const state = { items:[], current:null, group:null, subjects:[], colors:{}, player:null, apiReady:false, tick:null, seeking:false, isLive: false, lastTap: 0, videoLoaded: false };
  const doubleTapDelay = 300; // ms for double tap
  const doubleTapSkip = 5; // seconds to skip
  let infoMessageTimeout;
  let controlsTimeout;

  // Basic route helpers
  function getRID(){ return new URLSearchParams(location.search).get('rid'); }

  // Enhanced YouTube ID extraction function
  function extractYouTubeID(urlOrId) {
    if (!urlOrId) return null;
    
    // Check if it's already a valid YouTube ID (11 characters)
    if (/^[a-zA-Z0-9_-]{11}$/.test(urlOrId)) return urlOrId;

    // Regular expressions for different YouTube URL formats
    const patterns = [
      // Standard watch URLs
      /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/|v\/|attribution_link\?a=))([a-zA-Z0-9_-]{11})/,
      // Short URLs
      /(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/)([a-zA-Z0-9_-]{11})/,
      // Mobile URLs
      /(?:https?:\/\/)?(?:m\.youtube\.com\/watch\?v=)([a-zA-Z0-9_-]{11})/,
      // YouTube Shorts
      /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/shorts\/)([a-zA-Z0-9_-]{11})/,
      // Live stream URLs
      /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/live\/)([a-zA-Z0-9_-]{11})/,
      // Embed URLs
      /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
      // nocookie embed URLs
      /(?:https?:\/\/)?(?:www\.)?(?:youtube-nocookie\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
      // Music URLs
      /(?:https?:\/\/)?(?:music\.youtube\.com\/watch\?v=)([a-zA-Z0-9_-]{11})/,
      // Channel URLs with video ID
      /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/channel\/[^\/]+\/)([a-zA-Z0-9_-]{11})/,
      // User URLs with video ID
      /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/user\/[^\/]+\/)([a-zA-Z0-9_-]{11})/,
      // c/ URLs with video ID
      /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/c\/[^\/]+\/)([a-zA-Z0-9_-]{11})/,
      // /v/ URLs
      /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/v\/)([a-zA-Z0-9_-]{11})/,
      // /e/ URLs
      /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/e\/)([a-zA-Z0-9_-]{11})/,
      // Partner program URLs
      /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/pp\/)([a-zA-Z0-9_-]{11})/,
      // Video ID in query parameters (fallback)
      /(?:v=|video_id=)([a-zA-Z0-9_-]{11})/,
      // Just extract any 11-character alphanumeric sequence that looks like a video ID
      /([a-zA-Z0-9_-]{11})/
    ];

    // Try each pattern
    for (const pattern of patterns) {
      const match = urlOrId.match(pattern);
      if (match && match[1]) {
        return match[1];
      }
    }

    return null;
  }

  // Format time as mm:ss or hh:mm:ss
  function fmt(seconds){
    seconds = Math.max(0, Math.floor(seconds||0));
    const h = Math.floor(seconds/3600);
    const m = Math.floor((seconds%3600)/60);
    const s = seconds%60;
    if (h>0) return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }

  // NEW: Function to show a temporary info message
  function showInfoMessage(message, duration = 1000) {
    const infoMessage = $('#infoMessage');
    if (!infoMessage) return;
    infoMessage.textContent = message;
    infoMessage.classList.add('active');
    clearTimeout(infoMessageTimeout);
    infoMessageTimeout = setTimeout(() => {
        infoMessage.classList.remove('active');
    }, duration);
  }

  // NEW: Function to show and hide controls
  function showControls() {
    const controls = $('#controls');
    if (!controls) return;
    controls.style.opacity = '1';
    controls.style.pointerEvents = 'all';
    clearTimeout(controlsTimeout);
    controlsTimeout = setTimeout(() => {
        controls.style.opacity = '0';
        controls.style.pointerEvents = 'none';
    }, 3000);
  }

  // NEW: Function to update progress bar background
  function updateProgressBar(seekBar, value, max) {
    const percentage = (value / max) * 100;
    seekBar.style.backgroundSize = `${percentage}% 100%`;
  }

  // Function to adjust video crop dynamically - UPDATED FOR ALL DEVICES
  function adjustVideoCrop() {
    const ytIframe = $('.yt-iframe');
    const ytHost = $('.yt-host');
    
    if (ytIframe && ytHost) {
      // Apply 50px crop to ALL devices
      ytHost.style.height = '110.2%'; // 1080/980 = 1.102 (for 50px crop from both sides)
      ytIframe.style.clipPath = 'inset(4.63% 0 4.63% 0)';
      ytIframe.style.webkitClipPath = 'inset(4.63% 0 4.63% 0)';
    }
  }

  // Function to enable the Attend Now button
  function enableAttendNowButton() {
    const attendNowBtn = $('#attendNowBtn');
    const attendNowMessage = $('#attendNowMessage');
    
    state.videoLoaded = true;
    attendNowBtn.disabled = false;
    attendNowBtn.innerHTML = '<i class="bx bx-play-circle"></i> Attend Now';
    attendNowMessage.textContent = 'Click the button below to begin the lesson in fullscreen mode';
  }

  // UI node refs
  const $ = sel => document.querySelector(sel);
  const $$ = sel => document.querySelectorAll(sel);

  function wireControls(){
    const playBtn = $('#playPause');
    const playIcon = $('#playIcon');
    const playLabel = $('#playLabel');
    const seekBar = $('#seekBar');
    const timeDisplayEl = $('#timeDisplay');
    const currentTimeEl = $('#currentTime');
    const totalTimeEl = $('#totalTime');
    const seekBarContainer = $('#seekBarContainer');
    const liveStatus = $('#liveStatus');
    const repeatStatus = $('#repeatStatus');
    const settingsBtn = $('#settingsBtn');
    const settingsMenu = $('#settingsMenu');
    const lsBtn = $('#lsBtn');
    const fsBtn = $('#fsBtn');
    const muteBtn = $('#muteBtn');
    const volumeIcon = $('#volumeIcon');
    const volumeSlider = $('#volumeSlider');
    const rewindBtn = $('#rewindBtn');
    const forwardBtn = $('#forwardBtn');
    const shell = $('#playerShell');
    const antiIframe = $('#antiIframe');
    const loadingText = $('#loadingText');
    const loadingOverlay = $('#loadingOverlay');
    const obscuraVideoHost = $('#obscuraVideoHost'); // Reference to the video host
    let lastVolume = state.player.getVolume();

    // NEW: Tap zones for mobile
    const rewindZone = $('#rewindZone');
    const centerZone = $('#centerZone');
    const forwardZone = $('#forwardZone');

    // Initialize progress bars
    updateProgressBar(seekBar, 0, 1000);
    updateProgressBar(volumeSlider, 100, 100);

    // Show/hide settings button on mobile
    if (window.innerWidth <= 768) {
      settingsBtn.style.display = 'inline-flex';
    } else {
      settingsBtn.style.display = 'inline-flex';
    }

    // Hide native controls on mobile
    if (window.innerWidth <= 768) {
        controls.style.opacity = 0;
        controls.style.pointerEvents = 'none';
    } else {
        controls.style.opacity = 1;
        controls.style.pointerEvents = 'all';
    }

    // Play/Pause
    playBtn.addEventListener('click', ()=>{
      if (!state.player) return;
      const st = state.player.getPlayerState();
      if (st === YT.PlayerState.PLAYING) {
        state.player.pauseVideo();
      } else {
        state.player.playVideo();
      }
    });

    // Volume control
    muteBtn.addEventListener('click', ()=>{
      if (!state.player) return;
      if (state.player.isMuted()) {
        state.player.unMute();
        state.player.setVolume(lastVolume);
        volumeSlider.value = lastVolume;
        updateProgressBar(volumeSlider, lastVolume, 100);
      } else {
        lastVolume = state.player.getVolume();
        state.player.mute();
        volumeSlider.value = 0;
        updateProgressBar(volumeSlider, 0, 100);
      }
    });

    volumeSlider.addEventListener('input', () => {
        if (!state.player) return;
        const vol = parseInt(volumeSlider.value, 10);
        state.player.setVolume(vol);
        updateProgressBar(volumeSlider, vol, 100);
        if (vol === 0) {
            state.player.mute();
        } else {
            state.player.unMute();
            lastVolume = vol; // Save volume
        }
    });

    // Update slider when volume changes via other means (e.g., YouTube's internal controls)
    state.player.addEventListener('onStateChange', (event) => {
        if (event.data === YT.PlayerState.PLAYING) {
            const vol = state.player.getVolume();
            const isMuted = state.player.isMuted();
            volumeSlider.value = isMuted ? 0 : vol;
            updateProgressBar(volumeSlider, isMuted ? 0 : vol, 100);
        }
    });

    // Add event listener for the new repeat label
    repeatStatus.addEventListener('click', () => {
      if (state.player) {
        state.player.seekTo(0, true);
        state.player.playVideo();
        showInfoMessage('Restart');
      }
    });

    // Add event listeners for skip buttons
    rewindBtn.addEventListener('click', () => {
      if (!state.player) return;
      const curTime = state.player.getCurrentTime();
      state.player.seekTo(Math.max(0, curTime - 5), true);
      showInfoMessage('-5s');
    });

    forwardBtn.addEventListener('click', () => {
      if (!state.player) return;
      const curTime = state.player.getCurrentTime();
      state.player.seekTo(curTime + 5, true);
      showInfoMessage('+5s');
    });

    // --- NEW: Mobile Tap Gestures ---
    rewindZone.addEventListener('touchend', (e) => {
      if (state.isLive) return; // Ignore for live streams
      const now = new Date().getTime();
      if (now - state.lastTap < doubleTapDelay) {
          state.player.seekTo(state.player.getCurrentTime() - doubleTapSkip, true);
          showInfoMessage(`-${doubleTapSkip}s`);
          e.preventDefault();
      }
      state.lastTap = now;
      showControls();
    });

    forwardZone.addEventListener('touchend', (e) => {
        if (state.isLive) return; // Ignore for live streams
        const now = new Date().getTime();
        if (now - state.lastTap < doubleTapDelay) {
            state.player.seekTo(state.player.getCurrentTime() + doubleTapSkip, true);
            showInfoMessage(`+${doubleTapSkip}s`);
            e.preventDefault();
        }
        state.lastTap = now;
        showControls();
    });

    centerZone.addEventListener('touchend', (e) => {
        // Only toggle play/pause on a single tap, not a double tap
        const now = new Date().getTime();
        if (now - state.lastTap >= doubleTapDelay || now - state.lastTap === 0) {
            const st = state.player.getPlayerState();
            if (st === YT.PlayerState.PLAYING) {
                state.player.pauseVideo();
            } else {
                state.player.playVideo();
            }
        }
        state.lastTap = now;
        showControls();
    });

    // Seek
    seekBar.addEventListener('input', ()=>{
      if (state.isLive) return;
      state.seeking = true;
      const dur = state.player ? (state.player.getDuration()||0) : 0;
      const target = (seekBar.value / 1000) * dur;
      currentTimeEl.textContent = fmt(target);
      totalTimeEl.textContent = fmt(dur);
      updateProgressBar(seekBar, seekBar.value, 1000);
    });
    seekBar.addEventListener('change', ()=>{
      if (state.isLive) return;
      const cur = state.player ? (state.player.getCurrentTime()||0) : 0;
      const dur = state.player ? (state.player.getDuration()||0) : 0;
      const target = (seekBar.value / 1000) * dur;
      if (state.player && Number.isFinite(target)) {
        state.player.seekTo(target, true);
      }
      state.seeking = false;
    });

    // Settings Menu logic
    settingsBtn.addEventListener('click', (e) => {
      // Calculate and set the menu's max height before showing it
      updateMenuHeight();
      settingsMenu.classList.toggle('active');
      if (settingsMenu.classList.contains('active')) {
          renderSettingsMenu();
      }
      e.stopPropagation(); // Prevent the body click listener from firing immediately
    });

    // Close settings menu when clicking outside
    document.body.addEventListener('click', (e) => {
      if (!settingsMenu.contains(e.target) && !settingsBtn.contains(e.target)) {
        settingsMenu.classList.remove('active');
      }
    });

    // Fullscreen for all devices - UPDATED: Always force landscape on mobile
    fsBtn.addEventListener('click', ()=>{
      const el = shell;
      if (!document.fullscreenElement) {
        if (el.requestFullscreen) {
            // Force landscape on ALL mobile devices in fullscreen
            if (window.innerWidth <= 768 && screen.orientation) {
                try {
                    screen.orientation.lock('landscape').then(() => {
                        el.requestFullscreen();
                    }).catch(e => {
                        console.error('Failed to lock orientation:', e);
                        el.requestFullscreen();
                    });
                } catch (e) {
                    console.error('Orientation lock API not available:', e);
                    el.requestFullscreen();
                }
            } else {
                el.requestFullscreen();
            }
        }
        else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
        else if (el.msRequestFullscreen) el.msRequestFullscreen();
        fsBtn.innerHTML = '<i class="bx bx-exit-fullscreen"></i><span>Exit</span>';
      } else {
        if (document.exitFullscreen) document.exitFullscreen();
        else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        else if (document.msExitFullscreen) document.msExitFullscreen();
        fsBtn.innerHTML = '<i class="bx bx-fullscreen"></i><span>Full</span>';
      }
    });

    // Handle fullscreen change events - UPDATED TO PAUSE VIDEO
    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) {
        fsBtn.innerHTML = '<i class="bx bx-fullscreen"></i><span>Full</span>';
        if (window.innerWidth <= 768) {
            // Unlock orientation on exit fullscreen
            if (screen.orientation) {
                try {
                    screen.orientation.unlock();
                } catch (e) {
                    console.error('Orientation unlock API not available:', e);
                }
            }
        }
        
        // When exiting fullscreen, pause the video, hide the player and show the attend now container
        if (state.player) {
          state.player.pauseVideo();
        }
        document.getElementById('playerShell').style.display = 'none';
        document.getElementById('attendNowContainer').style.display = 'flex';
      } else {
        fsBtn.innerHTML = '<i class="bx bx-exit-fullscreen"></i><span>Exit</span>';
      }
    });

    // --- Keyboard Shortcuts ---
    document.addEventListener('keydown', (e) => {
      if (!state.player) return;

      // Disable specific keyboard shortcuts for live streams
      if (state.isLive) {
          if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
              e.preventDefault();
              return;
          }
      }

      switch (e.key) {
        case ' ':
          e.preventDefault(); // Prevent spacebar from scrolling
          const st = state.player.getPlayerState();
          if (st === YT.PlayerState.PLAYING) {
            state.player.pauseVideo();
          } else {
            state.player.playVideo();
          }
          break;
        case 'ArrowLeft':
          if (!state.isLive) {
            state.player.seekTo(state.player.getCurrentTime() - 5, true);
          }
          break;
        case 'ArrowRight':
          if (!state.isLive) {
            state.player.seekTo(state.player.getCurrentTime() + 5, true);
          }
          break;
        case 'ArrowUp':
          const currentVolUp = state.player.getVolume();
          state.player.setVolume(Math.min(100, currentVolUp + 5));
          break;
        case 'ArrowDown':
          const currentVolDown = state.player.getVolume();
          state.player.setVolume(Math.max(0, currentVolDown - 5));
          break;
        case 'm':
          if (state.player.isMuted()) {
            state.player.unMute();
          } else {
            state.player.mute();
          }
          break;
        case 'f':
          if (!document.fullscreenElement) {
            shell.requestFullscreen();
          } else {
            document.exitFullscreen();
          }
          break;
      }
    });

    // Tick updater
    if (state.tick) clearInterval(state.tick);
    state.tick = setInterval(()=>{
      if (!state.player) return;
      const st = state.player.getPlayerState?.();
      const cur = state.player.getCurrentTime?.() || 0;
      const dur = state.player.getDuration?.() || 0;
      const vol = state.player.getVolume?.() || 100;
      const isMuted = state.player.isMuted?.() || false;

      if (!state.seeking){
        // Only update seek bar for non-live videos
        if (seekBarContainer.style.display !== 'none' && Number.isFinite(cur) && Number.isFinite(dur) && dur > 0) {
            const progressValue = Math.round((cur / dur) * 1000);
            seekBar.value = progressValue;
            updateProgressBar(seekBar, progressValue, 1000);
            currentTimeEl.textContent = fmt(cur);
            totalTimeEl.textContent = fmt(dur);
        }
      }

      // Update volume icon and slider position
      if (isMuted || vol === 0) {
        volumeIcon.className = 'bx bx-volume-mute';
        volumeSlider.value = 0;
        updateProgressBar(volumeSlider, 0, 100);
      } else if (vol < 50) {
        volumeIcon.className = 'bx bx-volume-low';
        volumeSlider.value = vol;
        updateProgressBar(volumeSlider, vol, 100);
      } else {
        volumeIcon.className = 'bx bx-volume-full';
        volumeSlider.value = vol;
        updateProgressBar(volumeSlider, vol, 100);
      }

      // icon/label
      if (st === YT.PlayerState.PLAYING) {
        playIcon.className = 'bx bx-pause';
        playLabel.textContent = 'Pause';
      } else {
        playIcon.className = 'bx bx-play';
        playLabel.textContent = 'Play';
      }

    }, 200);

    // This function will toggle the UI based on whether the video is a live stream.
    function updateLiveStatusUI() {
        if (!state.player) return;

        // Using a try/catch block to handle potential errors if the API is not ready
        try {
            const videoData = state.player.getVideoData();
            state.isLive = videoData.isLive === true;

            const relatedTitle = $('#relatedTitle');
            const relatedBar = $('#relatedBar');
            const relatedCards = $('#relatedCards');

            if (state.isLive) {
                // Show LIVE badge, hide progress bar, time row, and REPEAT label
                liveStatus.style.display = 'inline-block';
                repeatStatus.style.display = 'none';
                seekBarContainer.style.display = 'none';
                timeDisplayEl.style.display = 'none';
                rewindBtn.style.display = 'none';
                forwardBtn.style.display = 'none';
                settingsBtn.style.display = 'none'; // Hide settings button for live streams

                // Hide related parts
                if (relatedTitle) relatedTitle.style.display = 'none';
                if (relatedBar) relatedBar.style.display = 'none';
                if (relatedCards) relatedCards.style.display = 'none';
            } else {
                // Show progress bar, time row, and REPEAT label, hide LIVE badge
                liveStatus.style.display = 'none';
                repeatStatus.style.display = 'inline-block';
                seekBarContainer.style.display = 'flex';
                timeDisplayEl.style.display = 'inline-block';
                rewindBtn.style.display = 'inline-flex';
                forwardBtn.style.display = 'inline-flex';
                settingsBtn.style.display = 'inline-flex'; // Show settings button for normal videos

                // Show related parts
                if (relatedTitle) relatedTitle.style.display = 'block';
                if (relatedBar) relatedBar.style.display = 'block';
                if (relatedCards) relatedCards.style.display = 'grid'; // Re-show as grid
            }
        } catch (e) {
            console.error('Could not get video data. Retrying...');
            // Optional: You could use a setTimeout here to retry after a short delay
        }
    }

    // Call the function on relevant player events
    state.player.addEventListener('onStateChange', (event) => {
        const st = event.data;
        const isDesktop = window.innerWidth > 768;

        // Manage loading message and overlay visibility, only on desktop
        if (isDesktop) {
            if (st === YT.PlayerState.BUFFERING || st === YT.PlayerState.UNSTARTED) {
                loadingText.style.display = 'block';
                loadingOverlay.style.display = 'block';
                obscuraVideoHost.style.display = 'none';
            } else {
                loadingText.style.display = 'none';
                loadingOverlay.style.display = 'none';
                obscuraVideoHost.style.display = 'block';
            }
        } else {
            // On mobile, always show the video
            obscuraVideoHost.style.display = 'block';
        }

        // We check for PLAYING or BUFFERING state to ensure video data is available
        if (st === YT.PlayerState.PLAYING || st === YT.PlayerState.BUFFERING) {
            updateLiveStatusUI();
        }
    });
  }

  // Renders the playback speed menu directly
  function renderSettingsMenu() {
    if (!state.player) return;
    const settingsMenu = $('#settingsMenu');
    settingsMenu.innerHTML = ''; // Clear existing items

    // --- Playback Speed Section ---
    const rates = state.player.getAvailablePlaybackRates?.() || [0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75, 2];
    const currentRate = state.player.getPlaybackRate();
    rates.forEach(rate => {
      const btn = document.createElement('button');
      btn.className = 'menu-item';
      btn.textContent = rate === 1 ? 'Normal' : `${rate}x`;
      btn.dataset.rate = rate;
      if (rate === currentRate) {
        btn.classList.add('active');
      }
      btn.addEventListener('click', () => {
        state.player.setPlaybackRate(rate);
        // Update the active state immediately
        $$('#settingsMenu .menu-item').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');
      });
      settingsMenu.appendChild(btn);
    });
  }

  // Dynamically sets the max height of the settings menu to half the player's height.
  function updateMenuHeight() {
      const playerShell = $('#playerShell');
      const settingsMenu = $('#settingsMenu');
      if (playerShell && settingsMenu) {
          const playerHeight = playerShell.offsetHeight;
          const maxMenuHeight = playerHeight / 2;
          settingsMenu.style.maxHeight = `${maxMenuHeight}px`;
      }
  }

  // Initialize YT Player for the current item
  function initYT(videoId){
    const host = document.getElementById('ytPlayer');
    host.innerHTML = ''; // ensure clean

    state.player = new YT.Player('ytPlayer', {
      videoId,
      playerVars: {
        autoplay: 0, // Don't autoplay initially
        controls: 0,
        disablekb: 1,
        modestbranding: 1,
        rel: 0,
        fs: 0,
        playsinline: 1,
        iv_load_policy: 3,
        showinfo: 0, // This is key to hiding video title and channel info
        rel: 0 // Prevents related videos from showing
      },
      events: {
        onReady: (e) => {
          // Enable the Attend Now button now that the video is ready
          enableAttendNowButton();
          
          // Force the video to play at 1280x1080 if available
          try {
            // Set quality to highest available (might include 1080p)
            state.player.setPlaybackQuality('hd1080');
          } catch (e) {
            console.log('Could not set playback quality');
          }
          
          wireControls();
          renderSettingsMenu();
          updateMenuHeight();
          window.addEventListener('resize', updateMenuHeight);
          
          // Apply cropping initially
          adjustVideoCrop();
          
          // Update lesson info with video duration
          const duration = state.player.getDuration();
          if (duration && !isNaN(duration)) {
            const minutes = Math.floor(duration / 60);
            const seconds = Math.floor(duration % 60);
            document.getElementById('lessonDuration').textContent = `Duration: ${minutes}:${seconds.toString().padStart(2, '0')}`;
          }
        },
        onStateChange: (e) => {
          // Re-render settings menu on state change to update active quality
          if (e.data === YT.PlayerState.PLAYING) {
            // Re-render the correct menu to show updated active state
            const settingsMenu = $('#settingsMenu');
            if (settingsMenu.classList.contains('active')) {
                 renderSettingsMenu();
            }
            
            // Ensure cropping is maintained
            adjustVideoCrop();
          }
        },
        onPlaybackQualityChange: (e) => {
           // If the quality menu is open, re-render it to show the new active quality
           const settingsMenu = $('#settingsMenu');
           const isQualityMenu = settingsMenu.querySelector('[data-quality]');
           if (settingsMenu.classList.contains('active') && isQualityMenu) {
               renderSettingsMenu();
           }
        }
      }
    });
  }

  // Render page
  function renderPlayer(){
    const t = document.getElementById('playerTitle');
    if (!state.current){ t.textContent='Not found'; return; }

    t.textContent = `${state.current.lesson} — ${state.current.partTitle}`;

    // Update lesson info
    const lessonInfo = document.getElementById('lessonInfo');
    const lessonDescription = document.getElementById('lessonDescription');
    const lessonInstructor = document.getElementById('lessonInstructor');
    
    if (state.current.description) {
      lessonDescription.textContent = state.current.description;
    }
    
    if (state.current.instructor) {
      lessonInstructor.textContent = `Instructor: ${state.current.instructor}`;
    }

    // Buttons
    const tg = document.getElementById('telegramBtn');
    const rs = document.getElementById('resourceBtn');
    tg.href = state.current.telegram || '#';
    rs.href = state.current.resource || '#';

    // Related parts
    const rel = document.getElementById('relatedCards');
    rel.innerHTML = '';
    if (state.group){
      state.group.parts.forEach(p=>{
        const card = document.createElement('div'); 
        card.className='card';
        
        // Create thumbnail container with play overlay
        const thumbContainer = document.createElement('div');
        thumbContainer.style.position = 'relative';
        thumbContainer.style.cursor = 'pointer';
        
        const img = document.createElement('img');
        // Use Google Photos link directly from p.thumb
        img.src = p.thumb || '';
        img.alt = p.partTitle || '';
        img.style.width = '100%';
        img.style.height = '160px';
        img.style.objectFit = 'cover';
        img.style.display = 'block';
        
        // Create play icon overlay
        const playOverlay = document.createElement('div');
        playOverlay.className = 'play-overlay';
        const playIcon = document.createElement('div');
        playIcon.className = 'play-icon';
        playIcon.innerHTML = '<i class="bx bx-play"></i>';
        playOverlay.appendChild(playIcon);
        
        thumbContainer.appendChild(img);
        thumbContainer.appendChild(playOverlay);
        
        // Add click event to navigate to the video
        thumbContainer.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          window.location.href = `player.html?rid=${encodeURIComponent(p.id)}`;
        });
        
        card.appendChild(thumbContainer);

        const body = document.createElement('div'); 
        body.className='card-body';
        const tag = document.createElement('span'); 
        tag.className='tag-row';
        const dot = document.createElement('span'); 
        dot.className='dot'; 
        dot.style.setProperty('--subject-color', state.colors[state.group.subject]||'#000');
        tag.appendChild(dot);
        tag.appendChild(document.createTextNode(`${state.group.subject}`));
        const h4 = document.createElement('h4'); 
        h4.textContent = p.partTitle || '';
        const desc = document.createElement('p'); 
        desc.textContent = p.description || '';
        
        body.appendChild(tag); 
        body.appendChild(h4); 
        body.appendChild(desc);
        card.appendChild(body);
        rel.appendChild(card);
      });
    }
  }

  // Boot
  async function boot(){
    selenix.initHeader();

    // Back button functionality
    document.querySelector('[data-back]').addEventListener('click', () => {
      window.history.back();
    });

    // Attend Now button functionality
    document.getElementById('attendNowBtn').addEventListener('click', () => {
      if (!isSupportedBrowser()) {
        alert('Please use a supported browser (Chrome, Edge, Firefox, or Safari) to access this content.');
        return;
      }
      
      if (!state.videoLoaded) {
        alert('Video is still loading. Please wait...');
        return;
      }
      
      // Show the player shell
      document.getElementById('playerShell').style.display = 'block';
      
      // Hide the attend now container
      document.getElementById('attendNowContainer').style.display = 'none';
      
      // Enter fullscreen
      const shell = document.getElementById('playerShell');
      if (shell.requestFullscreen) {
        shell.requestFullscreen();
      } else if (shell.webkitRequestFullscreen) {
        shell.webkitRequestFullscreen();
      } else if (shell.msRequestFullscreen) {
        shell.msRequestFullscreen();
      }
      
      // Start playing the video
      if (state.player) {
        state.player.playVideo();
      }
    });

    try {
      state.items = await selenix.fetchSheet();
      state.subjects = selenix.uniqueSubjects(state.items);
      state.colors = selenix.subjectColorMap(state.subjects);
      const rid = getRID();
      state.current = state.items.find(x=>x.id===rid);
      if (state.current){
        const groups = selenix.groupByLesson(state.items);
        state.group = groups.find(g=>g.subject===state.current.subject && g.lesson===state.current.lesson);
      }
      renderPlayer();

      // Wait YouTube API then init
      function startIfReady(){
        if (window.YT && window.YT.Player){
          let vid = extractYouTubeID(state.current?.youtube);
          const playerTitle = document.getElementById('playerTitle');

          if (!vid) {
            // Set default video ID
            vid = '9i_UWs0tgJw'; // Replace with your default video ID

            // Show message to user
            playerTitle.textContent = 'Repeat වීඩියෝව තවමත් Upload කර නොමැත. කරුණාකර පසුව උත්සහ කරන්න';
            console.warn('No video found. Loading default video.');
          } else {
            // Show the actual video title if available
            playerTitle.textContent = `${state.current.lesson} — ${state.current.partTitle}`;
          }

          initYT(vid);

        } else {
          setTimeout(startIfReady, 80);
        }
      }
      startIfReady();

    } catch (e){
      console.error(e);
      document.getElementById('playerTitle').textContent = 'Failed to load player.';
    }
  }

  // YouTube API callback is required globally; we chain to boot if needed.
  function onYouTubeIframeAPIReady(){
    // If boot already ran, we'll init from there; otherwise boot will call later.
  }

  // Update on resize - UPDATED
  window.addEventListener('resize', adjustVideoCrop);

  // Update on fullscreen change - UPDATED
  document.addEventListener('fullscreenchange', function() {
    adjustVideoCrop();
    
    // Auto-pause when exiting fullscreen
    if (!document.fullscreenElement && state.player) {
      state.player.pauseVideo();
    }
  });
  document.addEventListener('webkitfullscreenchange', function() {
    adjustVideoCrop();
    
    // Auto-pause when exiting fullscreen
    if (!document.webkitFullscreenElement && state.player) {
      state.player.pauseVideo();
    }
  });
  document.addEventListener('mozfullscreenchange', function() {
    adjustVideoCrop();
    
    // Auto-pause when exiting fullscreen
    if (!document.mozFullScreen && state.player) {
      state.player.pauseVideo();
    }
  });
  document.addEventListener('MSFullscreenChange', function() {
    adjustVideoCrop();
    
    // Auto-pause when exiting fullscreen
    if (!document.msFullscreenElement && state.player) {
      state.player.pauseVideo();
    }
  });

  boot();
  </script>
</body>
</html>
